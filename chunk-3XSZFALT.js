import{a as Me}from"./chunk-YJRBJEMI.js";import{a as Te,b as Oe,c as Z,d as z,f as Ie}from"./chunk-KI76VGTE.js";import{a as _}from"./chunk-P6OX5KW3.js";import{b as ve,c as Se,e as xe,g as Ee,h as k,i as G,k as be}from"./chunk-NLB5HRRX.js";import{a as we}from"./chunk-5I5XZVIT.js";import{g as Pe}from"./chunk-5NPNKZ3O.js";import{j as Ce,r as _e}from"./chunk-VE6ZJ4JM.js";import{$ as q,$a as se,Ac as fe,B as ie,E as ne,Fb as w,J as N,Jb as x,Lb as m,Pb as ue,Qb as de,R as D,Rb as me,Sa as C,Sb as Y,T as re,Tb as pe,Wb as L,X as A,Xa as oe,Xb as T,Y as ae,Ya as O,a as p,aa as f,ab as H,b as P,fa as v,fb as B,fc as he,ga as S,gb as le,hb as ce,j as J,m as X,p as ee,pa as M,qb as E,rb as b,sa as F,tc as ye,vb as g,wb as c,wc as I,xb as d,xc as j,yb as u,z as te,zc as ge}from"./chunk-VRT4WXDD.js";var V={FREE:"FREE",PERCENTAGE:"PERCENTAGE",AMOUNT:"AMOUNT",PAYASYOUWANT:"PAYASYOUWANT"};var R=class n{http=f(_e);certificateService=f(Me);createOrder(i,e,t,r,s){let h=k(i,e,t,r,s);return this.http.post("/api/Payment",h).pipe(D(()=>te([...h.paymentDetailVMs.reduce((y,a)=>{let o=y.find(l=>l.instructor_id==a.instructorId);if(o){if(o.total_price+=a.totalValue,o.courses_names.push(...a.packagesId?a.courseNames:[a.courseName]),o.courses_ids.push(...a.packagesId?a.courseIds:[a.courseId]),o.coupon&&o.coupon.discount){let l=a.originalValue-a.totalValue;o.coupon.discount=(+o.coupon.discount+(l>0?l:0)).toFixed(2)}}else{let l=a.originalValue-a.totalValue;y.push(p(p({student_name:h.userName,student_email:h.userEmail,total_price:a.totalValue,courses_names:a.packagesId?a.courseNames:[a.courseName],courses_ids:a.packagesId?a.courseIds:[a.courseId],instructor_id:a.instructorId},a.packagesId&&{package:a.courseName}),a.coupon&&{coupon:p({code:a.coupon.coboneCode,type:a.coupon.coboneType==0?V.FREE:a.coupon.coboneType==1?V.AMOUNT:a.coupon.coboneType==2?V.PAYASYOUWANT:V.PERCENTAGE},a.coupon.coboneType&&{discount:l>0?l.toFixed(2):0,userId:a.coupon.userId})}))}return y},[]).map(y=>this.http.post(`${_.secondServerUrl}/course-order`,y)),...h.paymentDetailVMs.map(y=>this.certificateService.createCourseCertificate({id:y.courseName,certificateName_EN:y.courseName,certificateName_AR:y.courseName,certificateURL:y.courseName,courseId:y.courseId,courseName:y.courseName,userId:h.userId}))]).pipe(ne(()=>X))))}createStripePaymentIntent(i){return this.http.post(`${_.secondServerUrl}/meeting-order/create-stripe-payment-intent`,i)}verifyStripePaymentIntent(i){return this.http.post(`${_.secondServerUrl}/meeting-order/verify-stripe-payment`,i)}createTapCharge(i){return this.http.post(`${_.secondServerUrl}/meeting-order/create-tap-charge`,i)}static \u0275fac=function(e){return new(e||n)};static \u0275prov=A({token:n,factory:n.\u0275fac})};var U={PAYPAL:"PAYPAL",STRIPE:"STRIPE",FREE:"FREE",TAP:"TAP",FAWATEERK:"FAWATEERK"},W={COURSE:"COURSE"};var $=class n{ngZone=f(O);ngAfterViewInit(){this.ngZone.runOutsideAngular(()=>{fawaterkCheckout(window.pluginConfig)});let i=document.querySelector('link[href*="fawaterkPlugin.min.css"]'),e=document.querySelector('link[href*="fawaterkPluginHor"]');document.querySelector('link[href*="fawaterk.css"]')?(i?.remove(),e?.remove()):i?.setAttribute("href","fawaterk.css")}static \u0275fac=function(e){return new(e||n)};static \u0275dir=ce({type:n,selectors:[["","appFawaterk",""]]})};var Ue=["payPalButtonContainer"],Ne=(()=>{class n{constructor(e){this.zone=e}registerScript(e,t,r){let s=window[t];if(s){this.zone.run(()=>{r(s)});return}let h=document.createElement("script");h.id=this.getElemId(t),h.innerHTML="",h.onload=()=>{this.zone.run(()=>{r(window[t])})},h.src=e,h.async=!0,h.defer=!0,document.getElementsByTagName("head")[0].appendChild(h)}cleanup(e){let t=document.getElementById(this.getElemId(e));t&&t.remove()}getElemId(e){return`ngx-paypal-script-elem-${e}`}}return n.\u0275fac=function(e){return new(e||n)(q(O))},n.\u0275prov=A({token:n,factory:n.\u0275fac}),n})(),ke=(()=>{class n{constructor(e){this.scriptService=e,this.paypalWindowName="paypal"}registerPayPalScript(e,t){this.scriptService.registerScript(this.getUrlForConfig(e),this.paypalWindowName,t)}destroyPayPalScript(){this.scriptService.cleanup(this.paypalWindowName)}getUrlForConfig(e){let t=[{name:"client-id",value:e.clientId}];return e.locale&&t.push({name:"locale",value:e.locale}),e.currency&&t.push({name:"currency",value:e.currency}),e.commit&&t.push({name:"commit",value:e.commit}),e.vault&&t.push({name:"vault",value:e.vault}),e.intent&&t.push({name:"intent",value:e.intent}),e.funding&&t.push({name:"components",value:"buttons,funding-eligibility"}),e.extraParams&&t.push(...e.extraParams),`https://www.paypal.com/sdk/js${this.getQueryString(t)}`}getQueryString(e){let t="";for(let r=0;r<e.length;r++){let s=e[r];r===0?t+="?":t+="&",t+=`${s.name}=${s.value}`}return t}}return n.\u0275fac=function(e){return new(e||n)(q(Ne))},n.\u0275prov=A({token:n,factory:n.\u0275fac}),n})(),De=(()=>{class n{constructor(e,t,r){this.paypalScriptService=e,this.cdr=t,this.ngZone=r,this.registerScript=!0,this.scriptLoaded=new oe,this.ngUnsubscribe=new J,this.initializePayPal=!0}set payPalButtonContainer(e){this.payPalButtonContainerElem=e}ngOnChanges(e){this.payPalButtonContainerId||(this.payPalButtonContainerId=this.generateElementId());let t=this.config;e.config.isFirstChange()&&t&&this.registerScript&&this.initPayPalScript(t,r=>{this.payPal=r,this.doPayPalCheck()}),e.config.isFirstChange()||this.reinitialize(t)}ngOnDestroy(){this.paypalScriptService.destroyPayPalScript(),this.ngUnsubscribe.next(),this.ngUnsubscribe.complete()}ngAfterViewInit(){this.doPayPalCheck()}customInit(e){this.payPal=e,this.doPayPalCheck()}reinitialize(e){if(this.config=e,this.payPal=void 0,this.paypalScriptService.destroyPayPalScript(),this.payPalButtonContainerId=this.generateElementId(),this.initializePayPal=!0,this.payPalButtonContainerElem)try{for(;this.payPalButtonContainerElem.nativeElement.firstChild;)this.payPalButtonContainerElem.nativeElement.removeChild(this.payPalButtonContainerElem.nativeElement.firstChild)}catch(t){console.error(t)}this.cdr.detectChanges(),this.config&&(this.payPal?this.doPayPalCheck():this.initPayPalScript(this.config,t=>{this.payPal=t,this.doPayPalCheck()}))}doPayPalCheck(){this.initializePayPal&&this.config&&this.payPal&&this.payPalButtonContainerElem&&this.payPalButtonContainerElem.nativeElement.id&&(this.initializePayPal=!1,this.initPayPal(this.config,this.payPal))}initPayPalScript(e,t){this.paypalScriptService.registerPayPalScript({clientId:e.clientId,locale:e.advanced?.locale,commit:e.advanced&&e.advanced.commit?e.advanced.commit:void 0,currency:e.currency,vault:e.vault,intent:e.intent,funding:e.fundingSource!=null||e.fundingSource!=null,extraParams:e.advanced&&e.advanced.extraQueryParams?e.advanced.extraQueryParams:[]},r=>{this.scriptLoaded.next(r),t(r)})}generateElementId(){return`ngx-captcha-id-${this.generateGuid()}`}initPayPal(e,t){this.ngZone.runOutsideAngular(()=>{let r=(o,l)=>this.ngZone.run(()=>{if(e.createOrderOnClient&&e.createOrderOnServer)throw Error(`Both 'createOrderOnClient' and 'createOrderOnServer' are defined.
                    Please choose one or the other.`);if(!e.createOrderOnClient&&!e.createOrderOnServer)throw Error(`Neither 'createOrderOnClient' or 'createOrderOnServer' are defined.
                    Please define one of these to create order.`);if(e.createOrderOnClient)return l.order.create(e.createOrderOnClient(o));if(e.createOrderOnServer)return e.createOrderOnServer(o);throw Error("Invalid state for 'createOrder'.")}),s=(o,l)=>this.ngZone.run(()=>{if(e.createSubscriptionOnClient)return l.subscription.create(e.createSubscriptionOnClient(o))}),h=(o,l)=>this.ngZone.run(()=>{if(e.onShippingChange)return e.onShippingChange(o,l)}),y=p(p(p({style:e.style,fundingSource:void 0,onApprove:(o,l)=>this.ngZone.run(()=>{if(e.onApprove&&e.onApprove(o,l),e.authorizeOnServer)return e.authorizeOnServer(o,l);let Q=e.onClientAuthorization;Q&&l.order.capture().then(Re=>{this.ngZone.run(()=>{Q(Re)})})}),onError:o=>{this.ngZone.run(()=>{e.onError&&e.onError(o)})},onCancel:(o,l)=>{this.ngZone.run(()=>{e.onCancel&&e.onCancel(o,l)})},onClick:(o,l)=>{this.ngZone.run(()=>{e.onClick&&e.onClick(o,l)})},onInit:(o,l)=>{this.ngZone.run(()=>{e.onInit&&e.onInit(o,l)})}},(e.createOrderOnClient||e.createOrderOnServer)&&{createOrder:r}),e.createSubscriptionOnClient&&{createSubscription:s}),e.onShippingChange&&{onShippingChange:h}),a;switch(e.fundingSource){case"PAYPAL":a=t.FUNDING.PAYPAL;break;case"CARD":a=t.FUNDING.CARD;break;case"PAYLATER":a=t.FUNDING.PAYLATER;break;case"CREDIT":a=t.FUNDING.CREDIT;break;case"VENMO":a=t.FUNDING.VENMO;break;default:break}a!=null&&(y.fundingSource=a,e.fundingSource!=="PAYPAL"&&delete y.style?.color),t.Buttons(y).render(`#${this.payPalButtonContainerId}`)})}generateGuid(){let e=new Date().getTime(),t=performance&&performance.now&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let s=Math.random()*16;return e>0?(s=(e+s)%16|0,e=Math.floor(e/16)):(s=(t+s)%16|0,t=Math.floor(t/16)),(r=="x"?s:s&7|8).toString(16)})}}return n.\u0275fac=function(e){return new(e||n)(H(ke),H(fe),H(O))},n.\u0275cmp=B({type:n,selectors:[["ngx-paypal"]],viewQuery:function(e,t){if(e&1&&ue(Ue,5),e&2){let r;de(r=me())&&(t.payPalButtonContainer=r.first)}},inputs:{config:"config",registerScript:"registerScript"},outputs:{scriptLoaded:"scriptLoaded"},standalone:!1,features:[F],decls:2,vars:1,consts:[["payPalButtonContainer",""],[3,"id"]],template:function(e,t){e&1&&u(0,"div",1,0),e&2&&g("id",t.payPalButtonContainerId)},encapsulation:2,changeDetection:0}),n})(),Ae=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=le({type:n}),n.\u0275inj=ae({providers:[Ne,ke],imports:[Ce]}),n})();var He=["tapContainer"];function Be(n,i){if(n&1){let e=w();c(0,"button",7),x("click",function(){v(e);let r=m(2);return S(r.loadFawaterkPaymentMethodHandler())}),u(1,"img",8),c(2,"span",9),T(3,"/"),d(),u(4,"img",10),d()}if(n&2){let e=m(2);g("disabled",e.isPaying())}}function Ye(n,i){if(n&1){let e=w();c(0,"button",7),x("click",function(){v(e);let r=m(2);return S(r.loadTappyPaymentMethodHandler())}),u(1,"img",11),d()}if(n&2){let e=m(2);g("disabled",e.isPaying())}}function Le(n,i){if(n&1){let e=w();c(0,"button",7),x("click",function(){v(e);let r=m(2);return S(r.getStripePaymentIntentHandler(!0))}),u(1,"img",8),c(2,"span",9),T(3,"/"),d(),u(4,"img",10),d()}if(n&2){let e=m(2);g("disabled",e.isPaying())}}function je(n,i){if(n&1){let e=w();c(0,"div",2),E(1,Be,5,1,"button",3)(2,Ye,2,1,"button",3)(3,Le,5,1,"button",3),c(4,"ngx-stripe-elements",4)(5,"ngx-stripe-express-checkout",5),x("confirm",function(r){v(e);let s=m();return S(s.onWalletPaymentConfirm(r))})("cancel",function(){v(e);let r=m();return S(r.onWalletPaymentCancel())}),d()(),u(6,"ngx-paypal",6),d()}if(n&2){let e,t=m();C(),b((e=t.userCountry)==="EG"?1:e==="SA"?2:3),C(3),g("stripe",t.stripe)("elementsOptions",t.walletElementsOptions()),C(),g("options",t.walletOptions),C(),g("config",t.payPalConfig)}}function Ze(n,i){n&1&&(c(0,"div",15),u(1,"div",16)(2,"div",16),c(3,"div",17),u(4,"div",18)(5,"div",18),d(),u(6,"div",16),d(),u(7,"div",19))}function ze(n,i){n&1&&(c(0,"div",14),u(1,"div",20)(2,"div",20)(3,"div",20)(4,"div",20)(5,"div",20),d())}function We(n,i){n&1&&u(0,"div",21)(1,"div",22)(2,"div",23)(3,"div",19)}function $e(n,i){if(n&1&&E(0,Ze,8,0)(1,ze,6,0,"div",14)(2,We,4,0),n&2){let e,t=m(2);b((e=t.selectedPaymentMethod())===t.PAYMENTMETHOD.STRIPE?0:e===t.PAYMENTMETHOD.FAWATEERK?1:e===t.PAYMENTMETHOD.TAP?2:-1)}}function qe(n,i){n&1&&u(0,"span",27)}function Ge(n,i){if(n&1){let e=w();c(0,"ngx-stripe-elements",4)(1,"ngx-stripe-payment",25),x("loaderror",function(r){v(e);let s=m(3);return S(s.loadStripeErrorHandler(r))}),d()(),c(2,"button",26),x("click",function(){v(e);let r=m(3);return S(r.confirmStripePaymentHandler(!0))}),c(3,"span"),T(4,"\u0627\u062F\u0641\u0639 \u0627\u0644\u0622\u0646"),d(),E(5,qe,1,0,"span",27),d()}if(n&2){let e=m(3);g("stripe",e.stripe)("elementsOptions",e.cardElementsOptions()),C(),g("options",e.paymentElementOptions),C(),L(e.customPaymentBtnClass()),g("disabled",e.isPaying()),C(3),b(e.isPaying()?5:-1)}}function Ke(n,i){n&1&&u(0,"div",24)}function Qe(n,i){n&1&&u(0,"span",27)}function Je(n,i){n&1&&u(0,"span",27)}function Xe(n,i){if(n&1){let e=w();u(0,"div",28,0),c(2,"div",29)(3,"button",30),x("click",function(){v(e);let r=m(3);return S(r.confirmTapPaymentHandler())}),c(4,"span"),T(5,"\u0627\u062F\u0641\u0639 \u0627\u0644\u0622\u0646"),d(),E(6,Qe,1,0,"span",27),d(),c(7,"button",30),x("click",function(){v(e);let r=m(3);return S(r.confirmTappyPaymentHandler())}),c(8,"span"),T(9,"\u0627\u0644\u062A\u0642\u0633\u064A\u0637 \u0628\u0648\u0627\u0633\u0637\u0647 \u062A\u0627\u0628\u064A \u0639\u0644\u064A \u0627\u0631\u0628\u0639 \u062F\u0641\u0639\u0627\u062A"),d(),E(10,Je,1,0,"span",27),d()()}if(n&2){let e=m(3);C(3),L(e.customPaymentBtnClass()),g("disabled",e.isPaying()),C(3),b(e.isPaying()&&!e.isTappyInstallmentPayment()?6:-1),C(),L(e.customPaymentBtnClass()),g("disabled",e.isPaying()),C(3),b(e.isPaying()&&e.isTappyInstallmentPayment()?10:-1)}}function et(n,i){if(n&1&&E(0,Ge,6,7)(1,Ke,1,0,"div",24)(2,Xe,11,8),n&2){let e,t=m(2);b((e=t.selectedPaymentMethod())===t.PAYMENTMETHOD.STRIPE?0:e===t.PAYMENTMETHOD.FAWATEERK?1:e===t.PAYMENTMETHOD.TAP?2:-1)}}function tt(n,i){if(n&1){let e=w();c(0,"button",12),x("click",function(){v(e);let r=m();return S(r.selectedPaymentMethod.set(null))}),u(1,"span",13),c(2,"span"),T(3,"\u0627\u062E\u062A\u0631 \u0648\u0633\u064A\u0644\u0647 \u062F\u0641\u0639 \u0627\u062E\u0631\u064A"),d()(),E(4,$e,3,1)(5,et,3,1)}if(n&2){let e=m();g("disabled",e.isPaying()),C(4),b(e.loadingPaymentMethod()?4:5)}}var Ve=class n{totalValue=I.required();totalOriginalValue=I.required();courses=I.required();couponId=I();customPaymentBtnClass=I();fromCart=I();stripe=Ie(_.stripeKey);orderService=f(R);cartService=f(Te);toastService=f(we);currency=f(xe).currency();user=f(be).user();renderer=f(se);ngZone=f(O);router=f(Pe);cardElements=j(z);walletElements=j(Z);tapContainerElement=j("tapContainer");cardElementsOptions=M({locale:"ar",appearance:{theme:"stripe",labels:"above",variables:{colorPrimary:"#0a3e6e",fontFamily:"STC, sans-serif"}}});walletOptions={buttonType:{applePay:"buy",googlePay:"buy"},buttonHeight:55,layout:{maxColumns:1,maxRows:2}};walletElementsOptions=M({mode:"payment",amount:0,currency:"usd",locale:"ar"});paymentElementOptions={layout:{type:"accordion",defaultCollapsed:!1,radios:!1,spacedAccordionItems:!1}};userCountry=Ee();PAYMENTMETHOD=U;loadingPaymentMethod=M(!1);isPaying=M(!1);isTappyInstallmentPayment=M(!1);selectedPaymentMethod=M(null);payPalConfig={currency:"USD",clientId:_.paypalClientId,createOrderOnClient:()=>({intent:"CAPTURE",purchase_units:[{amount:{currency_code:"USD",value:this.totalValue().toString(),breakdown:{item_total:{currency_code:"USD",value:this.totalValue().toString()}}},items:this.courses().map(i=>({name:i.courseName_AR,quantity:"1",unit_amount:{currency_code:"USD",value:i.discountPrice?.toString()}}))}]}),advanced:{commit:"true",extraQueryParams:[{name:"disable-funding",value:"credit,card"}]},style:{label:"paypal",layout:"vertical",height:55},onApprove:(i,e)=>{},onClientAuthorization:()=>{this.isPaying()||(this.isPaying.set(!0),this.orderService.createOrder(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId()).subscribe({next:()=>{this.fromCart()?this.cartService.setCart({items:[],coupon:null}):this.cartService.updateCart(i=>P(p({},i),{items:i.items.filter(e=>!this.courses().find(t=>t.id===e.id))})),this.toastService.addToast({id:Date.now(),type:"success",title:"\u062A\u0645 \u0627\u0644\u0634\u0631\u0627\u0621 \u0628\u0646\u062C\u0627\u062D"}),this.router.navigate(["profile","my-courses"])},error:i=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:i.message})}}))},onCancel:()=>{this.toastService.addToast({id:Date.now(),type:"info",title:"\u062A\u0645 \u0627\u0644\u063A\u0627\u0621 \u0639\u0645\u0644\u064A\u0647 \u0627\u0644\u062F\u0641\u0639"})},onError:i=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:i.message})},onClick:(i,e)=>{}};constructor(){ye(()=>{this.tapContainerElement()&&this.initiateTapPaymentHandler()}),window.addEventListener("message",this.onMessageHandler.bind(this))}ngOnChanges(i){i.totalValue.currentValue!==i.totalValue.previousValue&&(this.selectedPaymentMethod.set(null),this.payPalConfig=P(p({},this.payPalConfig),{createOrderOnClient:()=>({intent:"CAPTURE",purchase_units:[{amount:{currency_code:"USD",value:i.totalValue.currentValue?.toString(),breakdown:{item_total:{currency_code:"USD",value:i.totalValue.currentValue?.toString()}}},items:this.courses().map(e=>({name:e.courseName_AR,quantity:"1",unit_amount:{currency_code:"USD",value:e.discountPrice?.toString()}}))}]})}),this.walletElementsOptions.update(e=>P(p({},e),{amount:i.totalValue.currentValue*100})))}getStripePaymentIntentHandler(i=!1){this.isPaying()||(i&&this.selectedPaymentMethod.set(U.STRIPE),this.loadingPaymentMethod.set(!0),this.orderService.createStripePaymentIntent({amount:this.totalValue()*100,currency:"usd",cardsOnly:i}).subscribe({next:({clientSecret:e})=>{i&&this.cardElementsOptions.update(t=>P(p({},t),{clientSecret:e,mode:void 0})),this.loadingPaymentMethod.set(!1)},error:e=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:e.message})}}))}loadStripeErrorHandler({error:i}){this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:i.message})}loadFawaterkPaymentMethodHandler(){this.isPaying()||(this.selectedPaymentMethod.set(U.FAWATEERK),window.pluginConfig={hashKey:_.fawateerk_hash_key,envType:ge()?"test":"live",style:{listing:"horizontal"},version:"0",requestBody:{cartTotal:Math.ceil(this.totalValue()*this.currency.value).toString(),currency:"EGP",customer:{first_name:this.user?.firstName?.trim(),last_name:(this.user?.familyName||this.user?.firstName)?.trim(),email:this.user?.email,phone:"0123456789"},redirectionUrls:{successUrl:`${location.origin}/confirm-order?status=success`,failUrl:`${location.origin}/confirm-order?status=failed`,pendingUrl:`${location.origin}/confirm-order?status=pending`},cartItems:this.courses().map(i=>({name:i.courseName_AR,quantity:"1",price:Math.ceil(i.discountPrice*this.currency.value).toString()})),payLoad:P(p({},k(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId())),{fromCart:this.fromCart(),skipOnlineCheck:!0,type:W.COURSE})}},typeof fawaterkCheckout>"u"?(this.loadingPaymentMethod.set(!0),G(ve,this.renderer,i=>{if(i){this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:i.message});return}this.loadingPaymentMethod.set(!1)})):this.loadingPaymentMethod.set(!1))}loadTappyPaymentMethodHandler(){this.isPaying()||(this.selectedPaymentMethod.set(U.TAP),typeof CardSDK>"u"?(this.loadingPaymentMethod.set(!0),G(Se,this.renderer,i=>{if(i){this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:i.message});return}this.loadingPaymentMethod.set(!1)})):this.loadingPaymentMethod.set(!1))}initiateTapPaymentHandler(){this.ngZone.runOutsideAngular(()=>{let{renderTapCard:i,Theme:e,Currencies:t,Direction:r,Edges:s,Locale:h}=CardSDK;i(this.tapContainerElement()?.nativeElement.id,{publicKey:_.tap_public_key,merchant:{id:_.tap_merchant_id},transaction:{amount:Math.ceil(this.totalValue()*this.currency.value).toString(),currency:t.SAR},customer:{name:[{first:this.user?.firstName?.trim(),last:(this.user?.familyName||this.user?.firstName)?.trim()}],contact:{email:this.user?.email}},acceptance:{supportedBrands:["VISA","MASTERCARD","MADA"],supportedCards:"ALL"},fields:{cardHolder:!0},addons:{displayPaymentBrands:!0,loader:!0},interface:{locale:h.AR,theme:e.LIGHT,edges:s.CURVED,direction:r.RTL},onReady:()=>{},onSuccess:y=>{this.isPaying.set(!0);let a=k(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId());this.orderService.createTapCharge({source:{id:y.id},customer:{email:this.user?.email,first_name:this.user?.firstName?.trim(),last_name:(this.user?.familyName||this.user?.firstName)?.trim()},currency:"SAR",description:"",amount:(this.totalValue()*this.currency.value).toFixed(2),metadata:P(p({},a),{paymentDetailVMs:JSON.stringify(a.paymentDetailVMs),fromCart:this.fromCart(),skipOnlineCheck:!0,type:W.COURSE,user_token:localStorage.getItem("courssat-user-token")}),post:{url:`${_.secondServerUrl}/courssat-event/tap/charge-webhook`}}).pipe(N(()=>this.isPaying.set(!1))).subscribe({next:({data:o})=>{window.open(o.transaction.url,"_self")},error:o=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:o.message})}})}})})}confirmTapPaymentHandler(){this.isPaying()||CardSDK.tokenize()}confirmTappyPaymentHandler(){if(this.isPaying())return;this.isPaying.set(!0),this.isTappyInstallmentPayment.set(!0);let{Currencies:i}=CardSDK,e=k(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId());this.orderService.createTapCharge({source:{id:"src_tabby.installement"},customer:{email:this.user?.email,first_name:this.user?.firstName?.trim(),last_name:(this.user?.familyName||this.user?.firstName)?.trim()},currency:i.SAR,description:"",amount:Math.ceil(this.totalValue()*this.currency.value).toString(),metadata:P(p({},e),{fromCart:this.fromCart(),skipOnlineCheck:!0,type:W.COURSE,paymentDetailVMs:JSON.stringify(e.paymentDetailVMs),user_token:localStorage.getItem("courssat-user-token")}),post:{url:`${_.secondServerUrl}/courssat-event/tap/charge-webhook`}}).pipe(N(()=>{this.isPaying.set(!1),this.isTappyInstallmentPayment.set(!1)})).subscribe({next:({data:t})=>{window.open(t.transaction.url,"_self")},error:t=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:t.message})}})}confirmStripePaymentHandler(i=!1){this.isPaying()||(this.isPaying.set(!0),i&&this.cardElements()?.elements.submit(),this.stripe.confirmPayment({elements:i?this.cardElements()?.elements:void 0,confirmParams:{payment_method_data:{billing_details:{name:this.user?.firstName+" "+this.user?.familyName,email:this.user?.email,address:{line1:"Av. Ramon Nieto 313B 2D",postal_code:"36205",city:"Vigo"}}}},redirect:"if_required",clientSecret:i?this.cardElementsOptions().clientSecret:""}).pipe(D(e=>ie(()=>!!e.error,ee(()=>new Error(e.error?.message??"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627")),this.orderService.createOrder(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId()))),N(()=>this.isPaying.set(!1))).subscribe({next:()=>{this.fromCart()?this.cartService.setCart({items:[],coupon:null}):this.cartService.updateCart(e=>P(p({},e),{items:e.items.filter(t=>!this.courses().find(r=>r.id===t.id))})),this.toastService.addToast({id:Date.now(),type:"success",title:"\u062A\u0645 \u0627\u0644\u0634\u0631\u0627\u0621 \u0628\u0646\u062C\u0627\u062D"}),this.router.navigate(["profile","my-courses"])},error:e=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:e.message})}}))}onMessageHandler(i){if(i.origin===location.origin&&i.data.confirmOrder&&i.data.status=="success"){if(this.isPaying())return;this.isPaying.set(!0),this.orderService.createOrder(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId()).pipe(N(()=>this.isPaying.set(!1))).subscribe({next:()=>{this.fromCart()?this.cartService.setCart({items:[],coupon:null}):this.cartService.updateCart(e=>P(p({},e),{items:e.items.filter(t=>!this.courses().find(r=>r.id===t.id))})),this.toastService.addToast({id:Date.now(),type:"success",title:"\u062A\u0645 \u0627\u0644\u0634\u0631\u0627\u0621 \u0628\u0646\u062C\u0627\u062D"}),this.router.navigate(["profile","my-courses"])},error:e=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:e.message})}})}}onWalletPaymentConfirm(i){let e=i.paymentIntent;if(e)switch(e.status){case"succeeded":this.orderService.verifyStripePaymentIntent({paymentIntentId:e.id}).pipe(re({subscribe:()=>{this.isPaying.set(!0)}}),D(()=>this.orderService.createOrder(this.user,this.totalValue(),this.totalOriginalValue(),this.courses(),this.couponId())),N(()=>this.isPaying.set(!1))).subscribe({next:()=>{this.fromCart()?this.cartService.setCart({items:[],coupon:null}):this.cartService.updateCart(t=>P(p({},t),{items:t.items.filter(r=>!this.courses().find(s=>s.id===r.id))})),this.toastService.addToast({id:Date.now(),type:"success",title:"\u062A\u0645 \u0627\u0644\u0634\u0631\u0627\u0621 \u0628\u0646\u062C\u0627\u062D"}),this.router.navigate(["profile","my-courses"])},error:t=>{this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:t.message})}});break;case"processing":this.toastService.addToast({id:Date.now(),type:"info",title:"\u062A\u0646\u0628\u064A\u0647",message:"\u0639\u0645\u0644\u064A\u0647 \u0627\u0644\u062F\u0641\u0639 \u0642\u064A\u062F \u0627\u0644\u0645\u0631\u0627\u062C\u0639\u0647"});break;default:this.toastService.addToast({id:Date.now(),type:"error",title:"\u062D\u062F\u062B \u062E\u0637\u0627 \u0645\u0627",message:"\u062A\u0645 \u0627\u0644\u063A\u0627\u0621 \u0639\u0645\u0644\u064A\u0647 \u0627\u0644\u062F\u0641\u0639"})}}onWalletPaymentCancel(){this.toastService.addToast({id:Date.now(),type:"info",title:"\u062A\u0646\u0628\u064A\u0647",message:"\u062A\u0645 \u0627\u0644\u063A\u0627\u0621 \u0639\u0645\u0644\u064A\u0647 \u0627\u0644\u062F\u0641\u0639"})}ngOnDestroy(){window.removeEventListener("message",this.onMessageHandler.bind(this))}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=B({type:n,selectors:[["app-payment-methods"]],viewQuery:function(e,t){e&1&&(Y(t.cardElements,z,5),Y(t.walletElements,Z,5),Y(t.tapContainerElement,He,5)),e&2&&pe(3)},inputs:{totalValue:[1,"totalValue"],totalOriginalValue:[1,"totalOriginalValue"],courses:[1,"courses"],couponId:[1,"couponId"],customPaymentBtnClass:[1,"customPaymentBtnClass"],fromCart:[1,"fromCart"]},features:[he([R]),F],decls:4,vars:1,consts:[["tapContainer",""],[1,"text-lg","lg:text-3xl","font-bold","text-body-5","mb-5","lg:mb-10"],[1,"flex","flex-col","gap-3","lg:gap-4"],[1,"btn","btn-dash","btn-xl","text-body-5","font-normal","gap-4","justify-start","h-15","lg:h-20",3,"disabled"],[3,"stripe","elementsOptions"],[3,"confirm","cancel","options"],[3,"config"],[1,"btn","btn-dash","btn-xl","text-body-5","font-normal","gap-4","justify-start","h-15","lg:h-20",3,"click","disabled"],["src","images/Master-card.svg",1,"w-11","h-11","lg:w-17","lg:h-17"],[1,""],["src","images/Mada.svg",1,"w-11","h-11","lg:w-17","lg:h-17"],["src","images/Tabby.svg",1,"w-18","h-7","lg:w-24","lg:h-10"],[1,"btn","btn-link","h-auto","dark:text-base-content","mb-4","px-0!",3,"click","disabled"],[1,"iconify","gg--arrow-right","text-xl"],[1,"flex","flex-wrap","gap-2"],[1,"flex","gap-3","flex-col","mb-10"],[1,"skeleton","h-11"],[1,"flex","gap-3"],[1,"skeleton","h-11","flex-1"],[1,"skeleton","w-full","h-12"],[1,"skeleton","h-11","w-1/3"],[1,"skeleton","w-full","h-12","mb-2"],[1,"skeleton","w-1/2","h-6","mb-10"],[1,"skeleton","w-full","h-12","mb-4"],["id","fawaterkDivId","appFawaterk",""],[3,"loaderror","options"],[1,"btn","btn-primary","w-2/3","lg:w-auto","h-12","mt-8","lg:mt-10",3,"click","disabled"],[1,"loading","loading-spinner"],["id","tap-container"],[1,"flex","flex-col","mt-8","lg:mt-10","gap-4"],[1,"btn","btn-primary","h-12",3,"click","disabled"]],template:function(e,t){e&1&&(c(0,"h3",1),T(1,"\u0637\u0631\u0642 \u0627\u0644\u062F\u0641\u0639"),d(),E(2,je,7,5,"div",2)(3,tt,6,2)),e&2&&(C(2),b(t.selectedPaymentMethod()?3:2))},dependencies:[Oe,z,$,Ae,De,Z],styles:[".payment-tabs__title[_ngcontent-%COMP%]{display:none}"],changeDetection:0})};export{R as a,Ve as b};
